<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>鄱阳湖水体分析系统</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
    }
    #map {
      height: 70vh;
      width: 100%;
    }
    #control-panel {
      padding: 15px;
      background: #f5f5f5;
      border-bottom: 1px solid #ddd;
    }
    #status-panel {
      padding: 10px;
      background: #E8F5E9;
      color: #2E7D32;
      margin: 10px;
      border-radius: 4px;
    }
    .error {
      background: #ffebee !important;
      color: #D32F2F !important;
    }
    button {
      padding: 8px 16px;
      background: #1A73E8;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #1765cc;
    }
    #debug-panel {
      position: fixed;
      bottom: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border: 1px solid #CCC;
      z-index: 1000;
      max-height: 200px;
      overflow-y: auto;
      width: 300px;
    }
    #chart-container {
      width: 100%;
      padding: 20px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <div id="control-panel">
    <h1>鄱阳湖水体分析</h1>
    <div id="status-panel">正在初始化系统...</div>
    <button id="analyze-btn">运行季节性分析</button>
    <select id="year-range">
      <option value="2020-2021" selected>2020-2021</option>
      <option value="2018-2020">2018-2020</option>
    </select>
  </div>
  
  <div id="map"></div>
  <canvas id="chart-container" height="200"></canvas>
  
  <div id="debug-panel">
    <h3>调试信息</h3>
    <div id="debug-log"></div>
  </div>

  <!-- 加载必要的库 -->
  <script src="https://code.earthengine.google.com/ee_api_install.js"></script>
  <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <script>
    // 全局变量
    let map;
    let chart;
    const START_YEAR = 2020;
    const END_YEAR = 2021;

    // 调试函数
    function debugLog(message) {
      const logElement = document.getElementById('debug-log');
      logElement.innerHTML += `<p>${new Date().toLocaleTimeString()}: ${message}</p>`;
      logElement.scrollTop = logElement.scrollHeight;
    }

    // 主初始化函数
    function init() {
      debugLog("开始初始化系统");
      updateStatus("正在加载Earth Engine...");
      
      ee.initialize(
        null,
        null,
        () => {
          debugLog("GEE初始化成功");
          updateStatus("正在初始化地图...");
          initMap();
          initControls();
        },
        (error) => {
          debugLog(`GEE初始化错误: ${error.message}`);
          if (error.message.includes('Not logged in')) {
            showAuthButton();
          } else {
            updateStatus(`初始化失败: ${error.message}`, true);
          }
        },
        { timeout: 15000 }
      );
    }

    // 初始化地图
    function initMap() {
      try {
        map = new google.maps.Map(document.getElementById('map'), {
          center: { lat: 29.0, lng: 116.3 }, // 鄱阳湖坐标
          zoom: 9,
          mapTypeId: 'hybrid'
        });
        debugLog("地图初始化成功");
        updateStatus("系统准备就绪");
      } catch (err) {
        handleError('地图初始化错误', err);
      }
    }

    // 初始化控件
    function initControls() {
      document.getElementById('analyze-btn').addEventListener('click', runAnalysis);
      debugLog("控件初始化完成");
    }

    // 运行分析
    function runAnalysis() {
      try {
        debugLog("开始水体分析");
        updateStatus("正在分析水体...");
        
        const yearRange = document.getElementById('year-range').value;
        const [startYear, endYear] = yearRange.split('-').map(Number);
        
        // 定义鄱阳湖区域
        const poyangLake = ee.Geometry.Polygon([
          [115.8, 29.6], [116.8, 29.6], [116.8, 28.6], [115.8, 28.6]
        ]);
        
        // 获取Landsat影像
        const collection = ee.ImageCollection('LANDSAT/LC08/C01/T1_SR')
          .filterBounds(poyangLake)
          .filterDate(ee.Date.fromYMD(startYear, 1, 1), ee.Date.fromYMD(endYear, 12, 31))
          .filter(ee.Filter.lt('CLOUD_COVER', 20));
        
        // 计算季节性变化
        calculateSeasonalChanges(collection, poyangLake);
      } catch (err) {
        handleError('分析过程中出错', err);
      }
    }

    // 计算季节性变化
    function calculateSeasonalChanges(collection, region) {
      try {
        debugLog("计算季节性水体变化");
        
        // 按月份分组
        const monthlyGroups = ee.List.sequence(1, 12).map(function(month) {
          month = ee.Number(month);
          return collection.filter(ee.Filter.calendarRange(month, month, 'month'))
            .median()
            .set('month', month);
        });
        
        // 计算每月水体面积
        const monthlyStats = monthlyGroups.map(function(image) {
          const ndwi = image.normalizedDifference(['B3', 'B5']);
          const water = ndwi.gt(0.2);
          const area = water.multiply(ee.Image.pixelArea()).reduceRegion({
            reducer: ee.Reducer.sum(),
            geometry: region,
            scale: 30,
            maxPixels: 1e12
          }).get('nd');
          
          return ee.Feature(null, {
            month: image.get('month'),
            area: area
          });
        });
        
        // 获取数据
        ee.data.computeFeatures({
          expression: monthlyStats,
          callback: function(features) {
            try {
              const data = features.map(f => ({
                month: f.properties.month,
                area: f.properties.area / 1000000 // 转换为平方公里
              }));
              
              renderChart(data);
              debugLog("季节性分析完成");
              updateStatus("分析完成");
            } catch (err) {
              handleError('数据处理错误', err);
            }
          }
        });
      } catch (err) {
        handleError('季节性分析错误', err);
      }
    }

    // 渲染图表
    function renderChart(data) {
      try {
        debugLog("渲染图表");
        
        const ctx = document.getElementById('chart-container').getContext('2d');
        
        // 如果已有图表，先销毁
        if (chart) {
          chart.destroy();
        }
        
        // 准备图表数据
        const months = ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'];
        const areaData = new Array(12).fill(0);
        
        data.forEach(item => {
          areaData[item.month - 1] = item.area;
        });
        
        // 创建新图表
        chart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: months,
            datasets: [{
              label: '水体面积(平方公里)',
              data: areaData,
              borderColor: '#4285F4',
              backgroundColor: 'rgba(66, 133, 244, 0.1)',
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            plugins: {
              title: {
                display: true,
                text: '鄱阳湖水体季节性变化'
              }
            },
            scales: {
              x: {
                title: { display: true, text: '月份' }
              },
              y: {
                title: { display: true, text: '水体面积(平方公里)' }
              }
            }
          }
        });
        
        debugLog("图表渲染完成");
      } catch (err) {
        handleError('图表渲染错误', err);
      }
    }

    // 显示认证按钮
    function showAuthButton() {
      debugLog("显示认证按钮");
      const statusPanel = document.getElementById('status-panel');
      statusPanel.innerHTML = `
        <p>需要Earth Engine认证</p>
        <button id="auth-btn">点击进行认证</button>
      `;
      
      document.getElementById('auth-btn').addEventListener('click', () => {
        debugLog("启动GEE认证流程");
        ee.data.authenticateViaPopup(
          () => {
            debugLog("认证成功，重新加载");
            location.reload();
          },
          error => {
            debugLog(`认证失败: ${error.message}`);
            updateStatus(`认证失败: ${error.message}`, true);
          }
        );
      });
    }

    // 更新状态
    function updateStatus(message, isError = false) {
      const statusPanel = document.getElementById('status-panel');
      statusPanel.textContent = message;
      statusPanel.className = isError ? 'error' : '';
      debugLog(`状态更新: ${message}`);
    }

    // 错误处理
    function handleError(context, error) {
      debugLog(`[ERROR] ${context}: ${error.message}`);
      console.error(error);
      updateStatus(`${context}: ${error.message}`, true);
    }

    // 启动应用
    window.addEventListener('load', init);

    // 暴露调试函数到全局
    window.debugLog = debugLog;
  </script>
</body>
</html>
