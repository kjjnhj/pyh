<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>鄱阳湖水体分析系统</title>
  <!-- 先加载jQuery -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
  <!-- 然后加载GEE库 - 使用官方最新URL -->
  <script src="https://earthengine.googleapis.com/v1/projects/earthengine-legacy/static/js/ee_api_js.js"></script>
  <!-- 最后加载Google Maps -->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCNwzyHL8XUS9UW3G9qrZymFVgD7Hqhgpc&callback=initMap"></script>
  <!-- 其他样式... -->
</head>
<body>
  <!-- 页面内容保持不变... -->
  
  <script>
    // 添加的库加载检查函数
    function checkEELibraryLoaded() {
      return new Promise((resolve, reject) => {
        if (typeof ee !== 'undefined' && ee.initialize) {
          resolve();
          return;
        }

        // 设置超时检查
        let checks = 0;
        const interval = setInterval(() => {
          if (typeof ee !== 'undefined' && ee.initialize) {
            clearInterval(interval);
            resolve();
          }
          if (checks++ > 10) {
            clearInterval(interval);
            reject(new Error('Earth Engine库加载超时'));
          }
        }, 500);
      });
    }

    // 修改后的初始化函数
    async function initializeApp() {
      try {
        updateStatus('正在加载Earth Engine库...');
        
        // 1. 确保GEE库已加载
        await checkEELibraryLoaded();
        
        // 2. 检查认证
        await checkAuth();
        
        // 3. 初始化GEE
        await initializeGEE();
        
        // ...其他初始化代码...
      } catch (error) {
        updateStatus('初始化失败: ' + error.message, true);
        console.error('初始化错误:', error);
      }
    }

    // 保持其他函数不变...
  </script>
</body>
</html>
